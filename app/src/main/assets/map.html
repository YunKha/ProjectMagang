<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Peta Gangguan Jaringan Kota Palu</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Debug Info */
        .debug-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1001;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Legend Styles */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            font-size: 14px;
            z-index: 1000;
            max-width: 200px;
        }

        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Popup Styles */
        .popup-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }

        .popup-field {
            margin: 8px 0;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 13px;
            margin-left: 5px;
        }

        .status-normal {
            background-color: #4CAF50;
            color: white;
        }

        .status-gangguan {
            background-color: #F44336;
            color: white;
        }

        .status-dikerjakan {
            background-color: #FF9800;
            color: white;
        }

        .btn-edit {
            margin-top: 12px;
            padding: 10px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 100%;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-modal {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-save {
            background-color: #4CAF50;
            color: white;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>

<div id="map"></div>

<!-- Legend -->
<div class="legend">
    <h4>üìä Status Jaringan</h4>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #4CAF50;"></div>
        <span class="legend-label">Normal</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #F44336;"></div>
        <span class="legend-label">Gangguan</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #FF9800;"></div>
        <span class="legend-label">Sedang Dikerjakan</span>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Ubah Status Jaringan</div>
        <div class="form-group">
            <label>Kecamatan</label>
            <input type="text" id="modal-region-name" readonly
                   style="background-color: #f5f5f5;">
        </div>
        <div class="form-group">
            <label>Status</label>
            <select id="modal-status">
                <option value="normal">üü© Normal</option>
                <option value="gangguan">üü• Gangguan</option>
                <option value="dikerjakan">üüß Sedang Dikerjakan</option>
            </select>
        </div>
        <div class="form-group">
            <label>Informasi Jaringan</label>
            <textarea id="modal-info" placeholder="Masukkan informasi detail..."></textarea>
        </div>
        <div class="modal-buttons">
            <button class="btn-modal btn-save" onclick="saveEdit()">üíæ Simpan</button>
            <button class="btn-modal btn-cancel" onclick="closeModal()">‚ùå Batal</button>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    // Global variables
    let map;
    let geojsonLayer;
    let userRole = 'user';
    let regionsData = {};
    let currentEditingRegion = null;

    // GeoJSON data
    const paluGeoJSON = {"type":"FeatureCollection","name":"palu_districts","features":[{"type":"Feature","properties":{"name":"Tatanga","status":"normal","info":"Tidak ada masalah","id":"tatanga"},"geometry":{"type":"Polygon","coordinates":[[[119.826325,-0.913427],[119.827316,-0.917845],[119.827965,-0.926539],[119.827792,-0.937191],[119.828917,-0.943345],[119.840338,-0.940836],[119.842848,-0.939452],[119.853101,-0.935039],[119.862067,-0.932347],[119.864522,-0.924636],[119.875338,-0.924074],[119.875373,-0.924107],[119.875365,-0.923923],[119.874498,-0.923418],[119.873776,-0.922118],[119.872403,-0.920168],[119.87132,-0.918868],[119.870742,-0.917495],[119.870381,-0.917134],[119.870381,-0.916484],[119.869875,-0.914823],[119.86937,-0.91309],[119.868936,-0.912241],[119.869442,-0.910147],[119.869442,-0.909641],[119.869225,-0.90928],[119.867492,-0.906897],[119.866769,-0.904766],[119.866772,-0.904677],[119.860621,-0.904758],[119.860621,-0.905368],[119.860519,-0.906994],[119.852693,-0.907604],[119.851778,-0.908823],[119.851372,-0.911466],[119.849745,-0.911262],[119.840395,-0.911669],[119.837346,-0.911669],[119.83389,-0.912482],[119.826325,-0.913427]]]}},{"type":"Feature","properties":{"name":"Taweli","status":"normal","info":"Semua sistem berjalan","id":"taweli"},"geometry":{"type":"Polygon","coordinates":[[[119.875353,-0.73846],[119.876506,-0.735824],[119.87789,-0.734743],[119.8804,-0.733921],[119.881568,-0.732537],[119.886878,-0.733694],[119.889431,-0.732136],[119.892156,-0.732526],[119.899165,-0.728546],[119.905525,-0.728849],[119.916373,-0.726026],[119.924333,-0.721787],[119.929481,-0.720446],[119.930693,-0.719667],[119.940416,-0.717363],[119.942796,-0.714768],[119.946516,-0.710745],[119.949242,-0.706981],[119.953557,-0.705705],[119.958013,-0.702547],[119.960047,-0.700297],[119.961691,-0.693116],[119.959571,-0.688617],[119.955764,-0.688185],[119.950053,-0.692165],[119.947327,-0.69316],[119.94564,-0.693679],[119.944104,-0.694068],[119.943758,-0.69489],[119.943196,-0.694155],[119.942244,-0.695323],[119.939172,-0.695625],[119.938826,-0.695972],[119.937485,-0.69662],[119.936966,-0.697399],[119.936966,-0.698134],[119.935636,-0.699443],[119.934857,-0.699789],[119.934814,-0.701347],[119.932867,-0.702731],[119.933429,-0.701303],[119.931612,-0.701433],[119.931179,-0.701],[119.930487,-0.701736],[119.928887,-0.702341],[119.927589,-0.703942],[119.926723,-0.70325],[119.925858,-0.703769],[119.923392,-0.703596],[119.920883,-0.705326],[119.920277,-0.704202],[119.919499,-0.705413],[119.919455,-0.706711],[119.916989,-0.707403],[119.916167,-0.708528],[119.916081,-0.709306],[119.914869,-0.709328],[119.914437,-0.710193],[119.913485,-0.710193],[119.897997,-0.708722],[119.894449,-0.706127],[119.878875,-0.703358],[119.882682,-0.696869],[119.887527,-0.684281],[119.896007,-0.677619],[119.910543,-0.663083],[119.921078,-0.655534],[119.925317,-0.64446],[119.922549,-0.64247],[119.909829,-0.641259],[119.899965,-0.641864],[119.883958,-0.647142],[119.877469,-0.65017],[119.844335,-0.698257],[119.84371,-0.70251],[119.846412,-0.703847],[119.847743,-0.704374],[119.850266,-0.707035],[119.851436,-0.708251],[119.853427,-0.709404],[119.855996,-0.710414],[119.858314,-0.710414],[119.859667,-0.712364],[119.859943,-0.713419],[119.860677,-0.713901],[119.8607,-0.714704],[119.860998,-0.715828],[119.861778,-0.71694],[119.856776,-0.724419],[119.856645,-0.724471],[119.856186,-0.724471],[119.856713,-0.726685],[119.854213,-0.733716],[119.853364,-0.734221],[119.853157,-0.735735],[119.85341,-0.73624],[119.853662,-0.738213],[119.853988,-0.738874],[119.853728,-0.742724],[119.855588,-0.744498],[119.856194,-0.745406],[119.85641,-0.745709],[119.856497,-0.746358],[119.857005,-0.746769],[119.856832,-0.747937],[119.858087,-0.748802],[119.858123,-0.748872],[119.861966,-0.742619],[119.875353,-0.73846]]]}},{"type":"Feature","properties":{"name":"Palu Utara","status":"normal","info":"Tidak ada gangguan","id":"palu_utara"},"geometry":{"type":"Polygon","coordinates":[[[119.913881,-0.791274],[119.913874,-0.791272],[119.911798,-0.788157],[119.909548,-0.784004],[119.907558,-0.78037],[119.905882,-0.772919],[119.903156,-0.772486],[119.90268,-0.77147],[119.898959,-0.771816],[119.892167,-0.771773],[119.880876,-0.768831],[119.873434,-0.766149],[119.872872,-0.759574],[119.87828,-0.758795],[119.905535,-0.761304],[119.905708,-0.750814],[119.889571,-0.749905],[119.886457,-0.748521],[119.882433,-0.745363],[119.877285,-0.742443],[119.875684,-0.740626],[119.875295,-0.738593],[119.875353,-0.73846],[119.861966,-0.742619],[119.858123,-0.748872],[119.859082,-0.750749],[119.860034,-0.752047],[119.860207,-0.753301],[119.860293,-0.754512],[119.860856,-0.75607],[119.858822,-0.76072],[119.858606,-0.761715],[119.858606,-0.76271],[119.857481,-0.765349],[119.857741,-0.766473],[119.857265,-0.767209],[119.857178,-0.767901],[119.857351,-0.769285],[119.857481,-0.772227],[119.857005,-0.773806],[119.857568,-0.775796],[119.857871,-0.778348],[119.858476,-0.779862],[119.859125,-0.783193],[119.859039,-0.784318],[119.859774,-0.785356],[119.860683,-0.785356],[119.861245,-0.786005],[119.861634,-0.788492],[119.862413,-0.788406],[119.863019,-0.789098],[119.863711,-0.789487],[119.863754,-0.78979],[119.864533,-0.790266],[119.864749,-0.790871],[119.865571,-0.791391],[119.865571,-0.791737],[119.865874,-0.792126],[119.86648,-0.792602],[119.86648,-0.793294],[119.866999,-0.794765],[119.869076,-0.795587],[119.8702,-0.797057],[119.871325,-0.797706],[119.873229,-0.798225],[119.87431,-0.799134],[119.87643,-0.80108],[119.877036,-0.802248],[119.876387,-0.803416],[119.875684,-0.804],[119.876895,-0.805861],[119.877804,-0.808845],[119.877155,-0.811008],[119.877674,-0.811744],[119.877977,-0.812955],[119.877847,-0.813474],[119.878626,-0.814642],[119.878972,-0.816243],[119.879102,-0.818362],[119.880248,-0.818772],[119.884801,-0.818632],[119.892971,-0.809419],[119.895578,-0.808724],[119.913881,-0.791274]]]}},{"type":"Feature","properties":{"name":"Mantikulore","status":"normal","info":"Sistem normal","id":"mantikulore"},"geometry":{"type":"Polygon","coordinates":[[[119.9288,-0.915803],[119.928638,-0.915347],[119.929633,-0.914395],[119.948452,-0.911237],[119.955353,-0.912189],[119.960847,-0.914654],[119.968461,-0.914179],[119.975546,-0.915866],[120.009053,-0.900282],[120.009356,-0.89773],[120.009788,-0.897254],[120.013249,-0.8976],[120.017402,-0.896995],[120.020214,-0.888148],[120.023502,-0.88711],[120.025406,-0.885672],[120.025709,-0.883293],[120.022983,-0.879573],[120.022421,-0.878361],[120.021642,-0.876415],[120.021772,-0.872889],[120.023632,-0.867871],[120.035389,-0.85245],[120.037033,-0.848167],[120.033702,-0.840965],[120.034956,-0.833092],[120.025233,-0.820439],[120.02532,-0.816978],[120.024335,-0.813625],[120.024768,-0.808781],[120.020052,-0.803763],[120.016981,-0.797533],[120.01352,-0.79537],[120.010145,-0.796149],[120.003677,-0.795933],[120.000952,-0.796928],[119.998053,-0.797014],[119.995803,-0.798745],[119.992948,-0.802205],[119.988589,-0.805287],[119.980889,-0.807018],[119.978076,-0.810824],[119.975957,-0.810824],[119.968905,-0.808618],[119.964881,-0.809137],[119.962761,-0.808359],[119.96181,-0.806628],[119.960944,-0.805158],[119.957051,-0.801178],[119.949902,-0.797814],[119.938999,-0.796646],[119.93662,-0.7963],[119.930433,-0.797339],[119.923641,-0.796993],[119.920234,-0.793954],[119.913881,-0.791274],[119.895578,-0.808724],[119.892971,-0.809419],[119.884801,-0.818632],[119.880248,-0.818772],[119.880313,-0.818795],[119.881005,-0.81966],[119.881568,-0.819833],[119.882606,-0.821672],[119.882909,-0.823532],[119.881568,-0.825132],[119.879491,-0.828896],[119.879578,-0.832356],[119.880573,-0.834281],[119.879924,-0.836531],[119.879881,-0.838737],[119.879578,-0.839126],[119.879837,-0.841246],[119.878799,-0.843582],[119.879318,-0.845009],[119.879318,-0.847389],[119.879545,-0.848924],[119.879026,-0.849962],[119.87842,-0.85126],[119.878247,-0.852125],[119.879242,-0.852991],[119.878561,-0.855164],[119.877869,-0.858149],[119.878604,-0.858711],[119.878907,-0.860269],[119.878777,-0.862691],[119.876268,-0.865114],[119.874148,-0.867536],[119.872764,-0.869353],[119.871909,-0.871959],[119.872602,-0.874901],[119.870655,-0.874598],[119.870049,-0.874641],[119.870136,-0.875506],[119.870309,-0.877366],[119.871563,-0.87914],[119.871225,-0.879616],[119.875388,-0.883391],[119.876549,-0.883584],[119.877711,-0.886004],[119.87926,-0.886972],[119.88226,-0.88852],[119.882744,-0.889488],[119.883519,-0.891037],[119.885745,-0.892101],[119.886713,-0.895634],[119.888068,-0.899892],[119.888746,-0.904925],[119.889714,-0.908409],[119.890198,-0.910539],[119.891456,-0.910442],[119.891746,-0.909377],[119.893586,-0.908797],[119.893005,-0.908313],[119.894457,-0.907829],[119.896877,-0.906087],[119.901126,-0.905433],[119.901232,-0.906073],[119.90262,-0.905966],[119.9039,-0.907674],[119.906248,-0.908314],[119.908169,-0.907674],[119.91724,-0.927948],[119.921509,-0.92688],[119.919375,-0.917917],[119.9288,-0.915803]]]}},{"type":"Feature","properties":{"name":"Palu Selatan","status":"gangguan","info":"Gangguan pada BTS Sector 2","id":"palu_selatan"},"geometry":{"type":"Polygon","coordinates":[[[119.869413,-0.910264],[119.868936,-0.912241],[119.86937,-0.91309],[119.869875,-0.914823],[119.870381,-0.916484],[119.870381,-0.917134],[119.870742,-0.917495],[119.87132,-0.918868],[119.872403,-0.920168],[119.873776,-0.922118],[119.874498,-0.923418],[119.875365,-0.923923],[119.875373,-0.924107],[119.877934,-0.926539],[119.877588,-0.932336],[119.87841,-0.934974],[119.880908,-0.936845],[119.888955,-0.933904],[119.901836,-0.941571],[119.931298,-0.941744],[119.937734,-0.940998],[119.9288,-0.915803],[119.919375,-0.917917],[119.921509,-0.92688],[119.91724,-0.927948],[119.908169,-0.907674],[119.906248,-0.908314],[119.9039,-0.907674],[119.90262,-0.905966],[119.901232,-0.906073],[119.901126,-0.905433],[119.896877,-0.906087],[119.894457,-0.907829],[119.893005,-0.908313],[119.893586,-0.908797],[119.891746,-0.909377],[119.891456,-0.910442],[119.890198,-0.910539],[119.889714,-0.908409],[119.889004,-0.905856],[119.883419,-0.90662],[119.880241,-0.90662],[119.879663,-0.906259],[119.875474,-0.907198],[119.876052,-0.909148],[119.876052,-0.910592],[119.874752,-0.910375],[119.874463,-0.91052],[119.873596,-0.910664],[119.871934,-0.910664],[119.871068,-0.910664],[119.870129,-0.910592],[119.869413,-0.910264]]]}},{"type":"Feature","properties":{"name":"Palu Timur","status":"dikerjakan","info":"Sedang perbaikan kabel fiber","id":"palu_timur"},"geometry":{"type":"Polygon","coordinates":[[[119.889004,-0.905856],[119.888746,-0.904925],[119.888068,-0.899892],[119.886713,-0.895634],[119.885745,-0.892101],[119.883519,-0.891037],[119.882744,-0.889488],[119.88226,-0.88852],[119.87926,-0.886972],[119.877711,-0.886004],[119.876549,-0.883584],[119.875388,-0.883391],[119.871225,-0.879616],[119.870828,-0.880178],[119.870136,-0.882081],[119.868751,-0.883379],[119.864079,-0.885585],[119.862262,-0.885196],[119.861829,-0.884763],[119.85919,-0.884504],[119.859087,-0.884498],[119.859546,-0.885122],[119.859402,-0.888155],[119.860341,-0.890249],[119.861135,-0.891261],[119.861135,-0.891983],[119.863374,-0.893788],[119.864675,-0.895522],[119.865614,-0.897038],[119.86583,-0.898122],[119.865975,-0.898772],[119.866553,-0.899422],[119.866553,-0.901444],[119.866841,-0.902527],[119.866769,-0.904766],[119.867492,-0.906897],[119.869225,-0.90928],[119.869442,-0.909641],[119.869442,-0.910147],[119.869413,-0.910264],[119.870129,-0.910592],[119.871068,-0.910664],[119.871934,-0.910664],[119.873596,-0.910664],[119.874463,-0.91052],[119.874752,-0.910375],[119.876052,-0.910592],[119.876052,-0.909148],[119.875474,-0.907198],[119.879663,-0.906259],[119.880241,-0.90662],[119.883419,-0.90662],[119.889004,-0.905856]]]}},{"type":"Feature","properties":{"name":"Ulujadi","status":"normal","info":"Operasional normal","id":"ulujadi"},"geometry":{"type":"Polygon","coordinates":[[[119.822781,-0.904095],[119.824374,-0.909085],[119.826062,-0.912254],[119.826325,-0.913427],[119.83389,-0.912482],[119.837346,-0.911669],[119.840395,-0.911669],[119.849745,-0.911262],[119.851372,-0.911466],[119.851778,-0.908823],[119.852693,-0.907604],[119.860519,-0.906994],[119.860621,-0.905368],[119.860621,-0.904758],[119.866772,-0.904677],[119.866841,-0.902527],[119.866553,-0.901444],[119.866553,-0.899422],[119.865975,-0.898772],[119.86583,-0.898122],[119.865614,-0.897038],[119.864675,-0.895522],[119.863374,-0.893788],[119.861135,-0.891983],[119.861135,-0.891261],[119.860341,-0.890249],[119.859402,-0.888155],[119.859546,-0.885122],[119.859087,-0.884498],[119.855989,-0.884331],[119.854172,-0.883552],[119.84885,-0.883076],[119.844697,-0.883033],[119.841669,-0.881649],[119.840371,-0.88087],[119.840358,-0.880861],[119.837671,-0.884444],[119.839503,-0.895193],[119.845794,-0.895591],[119.845953,-0.897582],[119.849855,-0.897821],[119.850174,-0.900926],[119.842768,-0.901006],[119.842609,-0.901324],[119.84229,-0.902837],[119.840857,-0.902359],[119.839264,-0.903315],[119.838866,-0.903872],[119.836636,-0.90443],[119.834486,-0.904907],[119.830504,-0.904828],[119.822859,-0.904111],[119.822781,-0.904095]]]}},{"type":"Feature","properties":{"name":"Palu Barat","status":"normal","info":"Jaringan berjalan dengan baik","id":"palu_barat"},"geometry":{"type":"Polygon","coordinates":[[[119.840358,-0.880861],[119.839246,-0.880048],[119.838078,-0.878794],[119.838078,-0.877237],[119.83652,-0.875939],[119.835871,-0.874944],[119.834963,-0.874165],[119.834487,-0.872651],[119.834574,-0.87038],[119.833449,-0.869991],[119.832627,-0.867871],[119.831253,-0.864486],[119.830128,-0.863016],[119.82935,-0.861328],[119.827879,-0.859209],[119.827403,-0.856959],[119.827446,-0.854753],[119.82684,-0.853153],[119.826116,-0.85166],[119.825943,-0.851401],[119.82577,-0.851184],[119.825596,-0.849281],[119.825164,-0.848286],[119.823823,-0.847421],[119.823563,-0.845518],[119.818328,-0.842317],[119.816771,-0.840976],[119.814867,-0.838769],[119.814305,-0.837039],[119.814348,-0.835525],[119.81358,-0.834249],[119.813104,-0.833038],[119.813191,-0.830918],[119.811763,-0.82763],[119.811806,-0.826462],[119.811806,-0.822634],[119.811071,-0.821812],[119.811806,-0.818784],[119.811504,-0.816751],[119.81159,-0.815929],[119.811763,-0.814545],[119.811374,-0.812252],[119.810941,-0.811041],[119.810811,-0.809483],[119.810595,-0.808748],[119.810595,-0.806974],[119.809297,-0.804812],[119.807394,-0.803903],[119.806096,-0.79988],[119.803457,-0.802692],[119.800428,-0.810003],[119.798352,-0.812555],[119.796881,-0.815886],[119.793517,-0.819379],[119.791267,-0.819119],[119.787633,-0.821282],[119.783826,-0.821023],[119.782528,-0.822018],[119.778462,-0.821801],[119.772405,-0.824916],[119.763925,-0.830064],[119.757923,-0.83918],[119.765753,-0.84701],[119.766229,-0.849519],[119.763806,-0.855251],[119.765018,-0.858928],[119.768479,-0.861696],[119.769214,-0.864768],[119.766316,-0.871105],[119.763676,-0.872186],[119.76121,-0.875733],[119.760994,-0.884947],[119.763493,-0.891187],[119.762627,-0.896681],[119.768338,-0.897979],[119.77141,-0.900358],[119.775217,-0.898238],[119.777034,-0.894388],[119.780365,-0.890841],[119.782042,-0.886061],[119.785589,-0.883422],[119.79104,-0.87516],[119.79303,-0.873733],[119.799693,-0.870272],[119.803846,-0.86971],[119.819139,-0.869796],[119.821822,-0.870964],[119.822601,-0.872132],[119.822125,-0.894572],[119.821952,-0.899439],[119.82273,-0.903937],[119.822781,-0.904095],[119.822859,-0.904111],[119.830504,-0.904828],[119.834486,-0.904907],[119.836636,-0.90443],[119.838866,-0.903872],[119.839264,-0.903315],[119.840857,-0.902359],[119.84229,-0.902837],[119.842609,-0.901324],[119.842768,-0.901006],[119.850174,-0.900926],[119.849855,-0.897821],[119.845953,-0.897582],[119.845794,-0.895591],[119.839503,-0.895193],[119.837671,-0.884444],[119.840358,-0.880861]]]}}]};

    // ‚úÖ Initialize map
    function initMap() {
        map = L.map('map', {
            center: [-0.8999, 119.8707],
            zoom: 12,
            zoomControl: true,
            attributionControl: true
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        loadGeoJSON();
    }

    function loadGeoJSON() {
        console.log('‚úÖ Loading GeoJSON data...');
        createGeoJSONLayer(paluGeoJSON);
    }

    function createGeoJSONLayer(geojsonData) {
        geojsonLayer = L.geoJSON(geojsonData, {
            style: function(feature) {
                return getFeatureStyle(feature);
            },
            onEachFeature: function(feature, layer) {
                bindPopupToFeature(feature, layer);
            }
        }).addTo(map);

        map.fitBounds(geojsonLayer.getBounds());
        console.log('‚úÖ GeoJSON loaded successfully');
    }

    function getFeatureStyle(feature) {
        const regionId = feature.properties.id || feature.properties.name.toLowerCase().replace(/ /g, '_');
        const region = regionsData[regionId];
        const status = region ? region.status : feature.properties.status || 'normal';

        return {
            fillColor: getColorByStatus(status),
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '',
            fillOpacity: 0.7
        };
    }

    function getColorByStatus(status) {
        switch(status.toLowerCase()) {
            case 'normal':
                return '#4CAF50';
            case 'gangguan':
                return '#F44336';
            case 'dikerjakan':
                return '#FF9800';
            default:
                return '#757575';
        }
    }

    function getStatusDisplay(status) {
        switch(status.toLowerCase()) {
            case 'normal':
                return 'üü© Normal';
            case 'gangguan':
                return 'üü• Gangguan';
            case 'dikerjakan':
                return 'üüß Sedang Dikerjakan';
            default:
                return status;
        }
    }

    function bindPopupToFeature(feature, layer) {
        const regionName = feature.properties.name;
        const regionId = feature.properties.id || regionName.toLowerCase().replace(/ /g, '_');

        layer.on('click', function() {
            const region = regionsData[regionId] || {
                name: regionName,
                status: feature.properties.status || 'normal',
                info: feature.properties.info || 'Tidak ada informasi'
            };

            const popupContent = createPopupContent(region, regionId);
            layer.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'custom-popup'
            }).openPopup();
        });

        layer.on('mouseover', function() {
            layer.setStyle({
                weight: 3,
                fillOpacity: 0.9
            });
        });

        layer.on('mouseout', function() {
            layer.setStyle({
                weight: 2,
                fillOpacity: 0.7
            });
        });
    }

    function createPopupContent(region, regionId) {
        const statusClass = 'status-' + region.status.toLowerCase();

        let html = `
            <div class="popup-title">${region.name}</div>
            <div class="popup-field">
                <span class="popup-label">Status:</span>
                <span class="status-badge ${statusClass}">
                    ${getStatusDisplay(region.status)}
                </span>
            </div>
            <div class="popup-field">
                <span class="popup-label">Informasi:</span>
                <div class="popup-value">${region.info}</div>
            </div>
        `;

        // ‚úÖ Debug: Log role check
        console.log('üîç Creating popup - userRole:', userRole, '| isAdmin:', userRole === 'admin');

        // ‚úÖ Add edit button for admin
        if (userRole === 'admin') {
            console.log('‚úÖ Adding edit button for admin');
            const safeInfo = (region.info || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
            html += `
                <button class="btn-edit" onclick="openEditModal('${regionId}', '${region.name}', '${region.status}', '${safeInfo}')">
                    ‚úèÔ∏è Ubah Status
                </button>
            `;
        } else {
            console.log('‚ùå No edit button - user is not admin');
        }

        return html;
    }

    function openEditModal(regionId, regionName, status, info) {
        console.log('üìù Opening edit modal:', {regionId, regionName, status, info});

        currentEditingRegion = regionId;
        document.getElementById('modal-region-name').value = regionName;
        document.getElementById('modal-status').value = status;
        document.getElementById('modal-info').value = info.replace(/&quot;/g, '"').replace(/\\'/g, "'");
        document.getElementById('editModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
        currentEditingRegion = null;
    }

    function saveEdit() {
        if (!currentEditingRegion) {
            console.error('‚ùå No region selected for editing');
            return;
        }

        const newStatus = document.getElementById('modal-status').value;
        const newInfo = document.getElementById('modal-info').value;

        if (!newInfo.trim()) {
            alert('Informasi tidak boleh kosong!');
            return;
        }

        console.log('üíæ Saving edit:', {
            regionId: currentEditingRegion,
            status: newStatus,
            info: newInfo
        });

        // ‚úÖ Call Android interface
        if (typeof Android !== 'undefined') {
            Android.onPolygonEdited(currentEditingRegion, newStatus, newInfo);
            console.log('‚úÖ Edit sent to Android');
        } else {
            console.error('‚ùå Android interface not available');
            alert('Tidak dapat menyimpan perubahan. Interface Android tidak tersedia.');
        }

        closeModal();
    }

    // ‚úÖ Set user role (called from Android)
    function setUserRole(role) {
        userRole = role ? role.toLowerCase() : 'user';

        console.log('üîê Role set:', userRole);
        console.log('üîê Is Admin:', userRole === 'admin');

        // ‚úÖ Update debug display
        document.getElementById('roleDisplay').textContent = role;
        document.getElementById('isAdminDisplay').textContent = (userRole === 'admin') ? 'YES ‚úÖ' : 'NO ‚ùå';

        // ‚úÖ Update all popups if map is loaded
        if (geojsonLayer) {
            console.log('üîÑ Refreshing popups with new role...');
            geojsonLayer.eachLayer(function(layer) {
                const regionId = layer.feature.properties.id ||
                                layer.feature.properties.name.toLowerCase().replace(/ /g, '_');
                const region = regionsData[regionId] || {
                    name: layer.feature.properties.name,
                    status: layer.feature.properties.status || 'normal',
                    info: layer.feature.properties.info || ''
                };

                // Rebind popup with updated role
                layer.unbindPopup();
                const popupContent = createPopupContent(region, regionId);
                layer.bindPopup(popupContent, {
                    maxWidth: 300,
                    className: 'custom-popup'
                });
            });
        }
    }

    // ‚úÖ Update all polygons (called from Android)
    function updateAllPolygons(dataJson) {
        try {
            const regions = JSON.parse(dataJson);
            console.log('üìä Updating polygons:', regions.length, 'regions');

            // Update regionsData object
            regionsData = {};
            regions.forEach(function(region) {
                regionsData[region.id] = region;
            });

            // Update styles
            if (geojsonLayer) {
                geojsonLayer.eachLayer(function(layer) {
                    const regionId = layer.feature.properties.id ||
                                    layer.feature.properties.name.toLowerCase().replace(/ /g, '_');
                    const region = regionsData[regionId];

                    if (region) {
                        // Update style
                        layer.setStyle({
                            fillColor: getColorByStatus(region.status),
                            weight: 2,
                            opacity: 1,
                            color: 'white',
                            fillOpacity: 0.7
                        });

                        // Rebind popup
                        layer.unbindPopup();
                        const popupContent = createPopupContent(region, regionId);
                        layer.bindPopup(popupContent, {
                            maxWidth: 300,
                            className: 'custom-popup'
                        });
                    }
                });
            }

            console.log('‚úÖ Polygons updated successfully');
        } catch (error) {
            console.error('‚ùå Error updating polygons:', error);
        }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    // ‚úÖ Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Initializing map...');
        initMap();
    });
</script>
</body>
</html>